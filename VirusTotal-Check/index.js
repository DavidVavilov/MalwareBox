const virusTotalLib = require('node-virustotal');
const defaultTimedInstance = virusTotalLib.makeAPI();
const virustotalApiKey = "a17564fbe21d34d28e35d7a9c01f8ab47fc29c7f2a79a495941dfa2ee2a60d9f";
const api = defaultTimedInstance.setKey(virustotalApiKey);

let fileName = process.argv[2]; //Gets file name from command line arguments
const waitTime = 10000;
console.log(fileName); 
const file = require('fs').readFileSync(fileName); //Opens the file

function delay(time) { //Delay function
    return new Promise(resolve => setTimeout(resolve, time));
}

const upload = api.uploadFile(file, fileName, 'application/x-msdownload', function(err, res){ //Uploads the file to VirusTotal
    let resJson = JSON.parse(res);
    if(err) {
        console.log(err);
    }else {
        console.log(resJson.data.id);
        delay(waitTime).then(() => { //Waits for 10 seconds for the file to be analyzed
            const searchFile = api.getAnalysisInfo(String(resJson.data.id), function(err, res) { //Gets the analysis for the file
                if(err){
                    console.log(err);
                }else {
                    console.log(JSON.parse(res));
                }
            })
        });
    }
})

